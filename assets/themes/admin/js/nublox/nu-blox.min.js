!function(a){"use strict";var b={$editArea:"",$jsonArea:"",$modulesEditArea:"",$content:"",modules:{},$modal:""},c=function(b,c){if(""!==c){if("toString"===b)return encodeURIComponent(JSON.stringify(c));if("toJson"===b){try{a.parseJSON(decodeURIComponent(c))}catch(d){return""}return a.parseJSON(decodeURIComponent(c))}}},d={create:function(a){var b={};return b._children=this.map(a),b},map:function(b){var e=[],f=a(b).find("[data-nublox-type]").first();if(0!==f.length){var g=f.siblings("[data-nublox-type]").andSelf();return a.each(g,function(b,f){var g=a(f).attr("data-nublox-param"),h=c("toJson",g);if("module"===h.type){var i=a(f).find("[data-nublox-module-param]").first(),j=i.attr("data-nublox-module-param"),k=c("toJson",j);"undefined"!=typeof k&&(h._module=k)}else{var l=d.map(f);"undefined"!=typeof l&&(h._children=l)}e.push(h)}),e}}},e=function(b,c){var d=a("#nuBlox-tpl-"+b).html();"undefined"==typeof d&&alert("template html file missing");var e=Handlebars.compile(d);return e(c)},f={partials:function(){a.each(["row","col","module","settings"],function(b,c){Handlebars.registerPartial(c,a("#nuBlox-tpl-"+c).html())}),a.each(b.modules,function(b,c){"row"!==b&&Handlebars.registerPartial("module-"+b,a("#nuBlox-tpl-module-"+b).html())})},helpers:function(){Handlebars.registerHelper("params",function(){var b={};return a.each(this,function(a,c){"_"!==a.slice(0,1)&&(b[a]=c)}),c("toString",b)}),Handlebars.registerHelper("partByType",function(){return this.type}),Handlebars.registerHelper("moduleByType",function(){return"module-"+this.editModule.type}),Handlebars.registerHelper("singleChildrenObj",function(){var a={_children:[this]};return a}),Handlebars.registerHelper("moduleInfo",function(a){return b.modules[this.type][a]}),Handlebars.registerHelper("ifCond",function(a,b,c){return a===b?c.fn(this):c.inverse(this)})}},g=function(){a("#nuBlox-panel").on("click",'[data-nublox-axn="remove"]',k.remove).on("click",'[data-nublox-axn="colsize+"],[data-nublox-axn="colsize-"]',k.colSize).on("click",'[data-nublox-axn="addCol"]',k.addCol).on("click",'[data-nublox-axn="selectRow"]',k.selectRow).on("click","[data-nublox-axn-addrow]",k.addRow).on("click",'[data-nublox-axn="selectModule"]',k.selectModule).on("click","[data-nublox-axn-addmodule]",k.addModule).on("click",'[data-nublox-axn="settings"]',k.editSettings).on("click",'[data-nublox-axn="editModule"]',k.editModule).on("click",'[data-nublox-axn="modalClose"]',l.close).on("click",'[data-nublox-axn="copy"]',k.copy).on("click",'[data-nublox-axn="selectTemplate"]',o.select).on("click","[data-nublox-axn-addtemplate]",o.add),a("body").on("click",'[data-nublox-axn="inlineClose"]',m.close).on("click",'[data-nublox-axn="save"]',k.save).on("click",".nuBlox-tab-menu [data-nublox-tab]",n.init),a(".nuBlox-sortable").sortable(i).disableSelection()},h=function(){a(".nuBlox-sortable").sortable(i,"refresh"),a(".nuBlox-col-content").removeClass("nuBlox-col-content-empty").each(function(b,c){var d=a(this).children(".nuBlox-row, .nuBlox-module");0===d.length&&a(this).addClass("nuBlox-col-content-empty")});var e=d.create(b.$content),f=c("toString",e);b.$jsonArea.val(f)},i={connectWith:".nuBlox-sortable",tolerance:"pointer",handle:".nuBlox-sortable-ico",placeholder:"nuBlox-sort-placeholder",forcePlaceholderSize:!0,stop:function(b,c){var d=a(c.item[0]),e=d.attr("data-nublox-type");if("module"===e){var f=d.parent().hasClass("nuBlox-content");f===!0&&a(this).sortable("cancel")}h()}},j={go:function(b,d){this.elem=b,this.attr="editModule"===d?"data-nublox-module-param":"data-nublox-param",this.$parent=a(b).closest("["+this.attr+"]"),this.paramString=this.$parent.attr(this.attr),this.paramJson=c("toJson",this.paramString),this.type=this.paramJson.type}},k={remove:function(){return j.go(this),"col"===j.type&&0===a(j.$parent).siblings().length?void alert("You can not delete the last column"):(j.$parent.remove(),void h())},copy:function(){j.go(this);var a=j.$parent.clone();a.insertAfter(j.$parent),h()},colSize:function(){j.go(this);var b=a(this).attr("data-nublox-axn");"colsize+"===b&&(j.paramJson.colSize<12?(j.$parent.removeClass("nuBlox-col-"+j.paramJson.colSize),j.paramJson.colSize++,j.$parent.addClass("nuBlox-col-"+j.paramJson.colSize)):alert("max width of column reached")),"colsize-"===b&&(j.paramJson.colSize>1?(j.$parent.removeClass("nuBlox-col-"+j.paramJson.colSize),j.paramJson.colSize--,j.$parent.addClass("nuBlox-col-"+j.paramJson.colSize)):alert("min width of column reached")),j.$parent.find(".nuBlox-col-displaycolumnsize").first().html(j.paramJson.colSize),j.$parent.attr("data-nublox-param",c("toString",j.paramJson)),h()},addCol:function(){j.go(this);var a={_children:[{colSize:12,type:"col"}]},b=e("col",a),c=j.$parent.find(".nuBlox-row-content").first();c.append(b),h()},selectRow:function(a){"fromAddModule"!==a&&j.go(this);var b={title:"Add row",foot:0,addRow:["12","6,6","4,4,4","3,3,3,3"]};l.open(b)},addRow:function(){var c=a(this).attr("data-nublox-axn-addrow").split(","),d=[];a.each(c,function(a,b){d.push({colSize:b,type:"col"})});var f={_children:[{_children:d,type:"row"}]},g=e("row",f);a(j.$parent).hasClass("nuBlox-row")?a(g).insertAfter(j.$parent):a(j.$parent).hasClass("nuBlox-col")?j.$parent.find(".nuBlox-col-content").first().append(g):b.$content.append(g),l.close(),h()},selectModule:function(){j.go(this);var a={title:"Add module",foot:0,addModule:b.modules};l.open(a)},addModule:function(){var b=a(this).attr("data-nublox-axn-addmodule");if("row"===b)l.close(),k.selectRow("fromAddModule");else{var c={_children:[{type:"module",_module:{type:b}}]},d=e("module",c);j.$parent.find(".nuBlox-col-content").first().append(d),l.close(),h()}},editSettings:function(){j.go(this);var a={title:"Settings",foot:1,settings:j.paramJson};l.open(a)},editModule:function(){j.go(this,"editModule");var a={title:"Edit module",foot:1,editModule:j.paramJson};0!==b.$modulesEditArea.length?m.open(a):l.open(a)},save:function(){var b=a(this).closest("form"),d=b.serializeObject(),e=a.extend(j.paramJson,d),f=c("toString",e);j.$parent.attr(j.attr,f),l.close(),m.close(),h()}},l={open:function(c){var d=e("modal",c);b.$modal=a(d),a("#nuBlox-modal").append(b.$modal).show()},close:function(){b.$modal.empty(),a("#nuBlox-modal").hide()}},m={open:function(c){var d=e("inline",c);b.$modulesEditArea.html(d),a("#nuBlox-panel").addClass("inlineOverflow")},close:function(){b.$modulesEditArea.empty(),a("#nuBlox-panel").removeClass("inlineOverflow")}},n={init:function(){var b=a(this).attr("data-nublox-tab"),c=a(this).closest(".nuBlox-tab").first();c.children("[data-nublox-tab]").hide(100),c.children('[data-nublox-tab="'+b+'"]').show(100)}},o={select:function(){var a={title:"Add from template",foot:0,addTemplate:[{name:"Demo template",content:"%7B%22_children%22%3A%5B%7B%22type%22%3A%22row%22%2C%22_children%22%3A%5B%7B%22colSize%22%3A3%2C%22type%22%3A%22col%22%2C%22col_xs%22%3A%2212%22%2C%22col_sm%22%3A%2212%22%2C%22col_md%22%3A%2212%22%2C%22margin%22%3A%5B%22%22%2C%22%22%2C%22%22%2C%22%22%5D%2C%22padding%22%3A%5B%22%22%2C%22%22%2C%22%22%2C%22%22%5D%2C%22border%22%3A%5B%22%22%2C%22%22%2C%22%22%2C%22%22%5D%2C%22id%22%3A%22%22%2C%22class%22%3A%22%22%2C%22background_color%22%3A%22%22%2C%22_children%22%3A%5B%7B%22type%22%3A%22module%22%2C%22_module%22%3A%7B%22type%22%3A%22icon%22%7D%7D%2C%7B%22type%22%3A%22module%22%2C%22_module%22%3A%7B%22type%22%3A%22icon%22%7D%7D%2C%7B%22type%22%3A%22module%22%2C%22_module%22%3A%7B%22type%22%3A%22icon%22%7D%7D%5D%7D%2C%7B%22colSize%22%3A9%2C%22type%22%3A%22col%22%2C%22_children%22%3A%5B%7B%22type%22%3A%22module%22%2C%22_module%22%3A%7B%22type%22%3A%22html%22%7D%7D%2C%7B%22type%22%3A%22row%22%2C%22_children%22%3A%5B%7B%22colSize%22%3A%226%22%2C%22type%22%3A%22col%22%2C%22_children%22%3A%5B%7B%22type%22%3A%22module%22%2C%22_module%22%3A%7B%22type%22%3A%22html%22%7D%7D%5D%7D%2C%7B%22colSize%22%3A%226%22%2C%22type%22%3A%22col%22%2C%22_children%22%3A%5B%7B%22type%22%3A%22module%22%2C%22_module%22%3A%7B%22type%22%3A%22html%22%7D%7D%5D%7D%5D%7D%5D%7D%5D%7D%5D%7D"}]};l.open(a)},add:function(){var d=a(this).attr("data-nublox-axn-addtemplate"),f=c("toJson",d),g=e("row",f);b.$content.append(g),l.close(),h()}};a.fn.nuBlox=function(d){var i=a.extend({json:"",modules:[],edit:""},d);b.$editArea=a(this),b.$jsonArea=a(i.json),b.$modulesEditArea="undefined"!=typeof i.edit?a(i.edit):"",a.each(i.modules,function(c,d){var f,g,h,i;"row"===d?(f=e("row",""),h="Row",i="fa fa-envelope"):(f=a("<div />").html(e("module-"+d,"")),g=f.find("[data-nublox-module-title]").first(),h=g.attr("data-nublox-module-title"),i=g.attr("data-nublox-module-icon")),b.modules[d]={title:h,icon:i}}),f.partials(),f.helpers();var j=b.$jsonArea.val(),k=c("toJson",j),l=e("panel",k);b.$editArea.append(l),b.$content=a(b.$editArea).find(".nuBlox-content"),g(),h()}}(jQuery);